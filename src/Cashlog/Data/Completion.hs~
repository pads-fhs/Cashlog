module Completion where

import Database.HDBC
import Database.HDBC.Sqlite3

wrapPair :: String
         -> String
         -> String
wrapPair n1 n2 = n1 ++ "(" ++ n2 ++ ")"

unwrapPair :: String
           -> (String,String)
unwrapPair p = let (n1,n2) = break (\b -> b == '(') p
               in  (n1, filter (\s -> not (s == '(' || s == ')')) n2)

wrapTriple :: String
           -> String
           -> String
           -> String
wrapTriple n1 n2 n3 = n1 ++ "(" ++ n2 ++ "/" ++ n3 ++ ")"

unwrapTriple :: String
             -> (String, String, String)
unwrapTriple t = let (n1,n23) = unwrapPair t
                     (n2,n3)  = break (\b -> b == '/') n23
                     n3'      = filter (\f -> f /= '/' n3
                 in  (n1,n2,n3')

isPrimaryKeyValid :: Connection
                  -> String
                  -> Int
                  -> IO Bool
isPrimaryKeyValid con table id = do
    queryResult <- quickQuery' con ("SELECT id FROM " ++ table ++ " WHERE id = ?") [toSql id]
    return $ not $ null queryResult

isArticleKey con = isPrimaryKeyValid con "article"
isCategoryKey con = isPrimaryKeyValid con "category"
isShopKey con = isPrimaryKeyValid con "shop"
isVoucherKey con = isPrimaryKeyValid con "voucher"

completeArticle :: Connection
                -> String
                -> IO [String]
completeArticle con word = do
    queryResult <- quickQuery' con ("SELECT name FROM article WHERE name LIKE '" ++ word ++"%'") []
    return $ map (\(n:[]) -> fromSql n) queryResult

articleIdFromName :: Connection
                  -> String
                  -> IO (Maybe Int)
articleIdFromName con name = do
    queryResult <- quickQuery' con "SELECT id FROM article WHERE name = ?" params
    case queryResult of
      (x:[]) -> return $ Just $ fromSql $ head x
      _      -> return Nothing
  where params = [ toSql name ]
  
completeCategory :: Connection
                 -> String
                 -> IO [String]
completeCategory con word = do
    queryResult <- quickQuery' con ("SELECT name FROM category WHERE name LIKE '" ++ word ++ "%'") []
    return $ map (\(n:[]) -> fromSql n) queryResult
    
categoryIdFromName :: Connection
                   -> String
                   -> IO (Maybe Int)
categoryIdFromName con name = do
    queryResult <- quickQuery' con "SELECT id FROM category WHERE name = ?" params
    case queryResult of
      (x:[]) -> return $ Just $ fromSql $ head x
      _      -> return Nothing
  where params = [ toSql name ]

completeShop :: Connection
             -> String
             -> IO [(String)]
completeShop con nc = do
    let (n,c) = unwrapPair nc
    queryResult <- quickQuery' con ("SELECT name, city FROM shop WHERE name LIKE '" ++ n ++ "%' AND city LIKE '" ++ c ++ "%'") []
    return $ map (\(n:c:[]) -> wrapPair (fromSql n) (fromSql c)) queryResult

shopIdFromNameAndCity :: Connection
                      -> String
                      -> IO (Maybe Int)
shopIdFromNameAndCity con nc = do
    let (n,c) = unwrapPair nc
        (n',c') = (toSql n, toSql c)
    queryResult <- quickQuery' con "SELECT id FROM shop WHERE name = ? AND city = ?" [n', c']
    case queryResult of
      (x:[]) -> return $ Just $ fromSql $ head x
      _      -> return Nothing

completeVoucher :: Connection
                -> String
                -> IO [(String)]
completeVoucher con dsc = do
    let (d,s,c) = unwrapTriple dsc
    queryResult <- quickQuery' con ("SELECT name, city FROM shop WHERE name LIKE '" ++ d ++ "%' AND city LIKE '" ++ s ++ "%'") []
    return $ map (\(n:c:[]) -> wrapPair (fromSql n) (fromSql c)) queryResult

voucherIdFromDateAndShop :: Connection
                         -> String
                         -> IO (Maybe Int)
voucherIdFromDateAndShop con dsc = do
    let (d,c,s)    = unwrapPair dsc
        (d',s',c') = (toSql d, toSql s, toSql c)
    queryResult <- quickQuery' con "SELECT id FROM shop WHERE name = ? AND city = ?" [d', s', c']
    case queryResult of
      (x:[]) -> return $ Just $ fromSql $ head x
      _      -> return Nothing

